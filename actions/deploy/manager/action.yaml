name: Manager Workflow Github Action
description: Manager Deploy Action
inputs:
  IMAGE_TAG:
    description: Image Tag
    required: true
  IMAGE_REPOSITORY:
    description: Docker image repository
    required: true
  ENVIRONMENT:
    description: Environment
    required: true
  MANAGER_NODE_IP:
    description: ip of managernode
    required: true
  VAULT_SERVER:
    description: Vault URL
    required: true
  VAULT_TOKEN:
    description: VAULT_TOKEN
    required: true
  VAULT_SECRET_PATH:
    description: Secret Path
    required: true
  VAULT_SECRET_COMMON_PATH:
    description: K8s common Secret Path
  VAULT_SECRETS_CICD_PATH:
    description: Vault Secrets Path
    required: true

runs:
  using: composite
  steps:

  - name: Export Secrets
    uses: hashicorp/vault-action@v2
    with:
      url: https://${{ inputs.VAULT_SERVER }}
      token: ${{ inputs.VAULT_TOKEN }}
      tlsSkipVerify: true
      secrets: |
          ${{ inputs.VAULT_SECRETS_CICD_PATH }} DEPLOY_USER | DEPLOY_USER;
          ${{ inputs.VAULT_SECRETS_CICD_PATH }} SSH_KEY | SSH_KEY;
          ${{ inputs.VAULT_SECRET_COMMON_PATH }} PROJECT_NAME | PROJECT_NAME;
          ${{ inputs.VAULT_SECRET_COMMON_PATH }} DJANGO_MODULE | DJANGO_MODULE;
          
  - name: Generate .env
    run: |
      curl -H "X-Vault-Token: ${{ inputs.VAULT_TOKEN }}" https://${{ inputs.VAULT_SERVER }}/v1/${{ inputs.VAULT_SECRET_PATH }} | jq -r .data > .env.json
      curl -H "X-Vault-Token: ${{ inputs.VAULT_TOKEN }}" https://${{ inputs.VAULT_SERVER }}/v1/${{ inputs.VAULT_SECRET_COMMON_PATH }} | jq -r .data > .common.env.json
      cat .env.json | jq -r 'to_entries[] | "\(.key)=\(.value)"' > .env
      cat .common.env.json | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> .env && cp .env ./app
    shell: bash
  
  - name: Create docker compose
    run: |
      export MODULE=${{ env.DJANGO_MODULE }}
      ansible-playbook -i ${{ github.action_path }}/ansible/inventory ${{ github.action_path }}/ansible/manager.yml
    shell: bash

  - name: Install SSH Key
    uses: shimataro/ssh-key-action@v2
    with:
      key: ${{ env.SSH_KEY }}
      known_hosts: 'SSH Key'
      if_key_exists: replace
  
  - name: Adding Known Hosts
    run: |
      ssh-keyscan -H ${{ inputs.MANAGER_NODE_IP }} >> ~/.ssh/known_hosts
    shell: bash
  
  - name: Rsync to Manager Node
    run: |
      ssh ${{ env.DEPLOY_USER }}@${{ inputs.MANAGER_NODE_IP }} "chown -R ${{ env.DEPLOY_USER }}: /opt/${{ env.PROJECT_NAME }} && rm -rf /opt/${{ env.PROJECT_NAME }}/*"
      rsync -avpPz --exclude ".git" --exclude ".gitignore" ./ ${{ env.DEPLOY_USER }}@${{ inputs.MANAGER_NODE_IP }}:/opt/${{ env.PROJECT_NAME }}
      ssh ${{ env.DEPLOY_USER }}@${{ inputs.MANAGER_NODE_IP }} 'cd /opt/${{ env.PROJECT_NAME }} && docker pull ${{ inputs.IMAGE_REPOSITORY }}/${{ github.repository }}-${{ inputs.ENVIRONMENT }}:${{ inputs.IMAGE_TAG }}'
      #ssh ${{ env.DEPLOY_USER }}@${{ inputs.MANAGER_NODE_IP }} 'cd /opt/${{ env.PROJECT_NAME }} && docker-compose -f docker-compose-manager.yml down && docker-compose -f docker-compose-manager.yml up -d'
    shell: bash
